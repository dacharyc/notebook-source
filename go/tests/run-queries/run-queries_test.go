package tests

import (
	"fmt"
	"github.com/joho/godotenv"
	"go.mongodb.org/mongo-driver/bson"
	"log"
	"os"
	"test-poc/example/manage-indexes"
	"test-poc/example/run-queries"
	"testing"
)

func TestAnnQueryBasic(t *testing.T) {
	// Test creating the index and performing a query that relies on the index
	var expected []run_queries.ProjectedMovieResult
	/* Note: we are maintaining different expectations for Atlas and local deployments because not all of the scores match
	 * There are the following discrepancies between scores:
	 * The Time Machine: Atlas: 0.7801066637039185 Local: 0.7801067233085632
	 * Timecop: Atlas: 0.7771612405776978 Local: 0.7771613597869873
	 * Men in Black 3: Atlas: 0.7712380886077881 Local: 0.7712380290031433
	 * Love Story 2050: Atlas: 0.7649372816085815 Local: 0.7649372220039368
	 */
	if err := godotenv.Load("../../.env"); err != nil {
		log.Println("no .env file found")
	}
	if os.Getenv("ENV") == "local" {
		expected = []run_queries.ProjectedMovieResult{
			{"Thrill Seekers", "A reporter, learning of time travelers visiting 20th century disasters, tries to change the history they know by averting upcoming disasters.", 0.7892671227455139},
			{"About Time", "At the age of 21, Tim discovers he can travel in time and change what happens and has happened in his own life. His decision to make his world a better place by getting a girlfriend turns out not to be as easy as you might think.", 0.7843604683876038},
			{"The Time Machine", "Hoping to alter the events of the past, a 19th century inventor instead travels 800,000 years into the future, where he finds humankind divided into two warring races.", 0.7801067233085632},
			{"Crusade in Jeans", "After using his mother's newly built time machine, Dolf gets stuck involuntary in the year 1212. He ends up in a children's crusade where he confronts his new friends with modern techniques...", 0.7789170742034912},
			{"Timecop", "An officer for a security agency that regulates time travel, must fend for his life against a shady politician who has a tie to his past.", 0.7771613597869873},
			{"A.P.E.X.", "A time-travel experiment in which a robot probe is sent from the year 2073 to the year 1973 goes terribly wrong thrusting one of the project scientists, a man named Nicholas Sinclair into a...", 0.7730885744094849},
			{"Men in Black 3", "Agent J travels in time to M.I.B.'s early days in 1969 to stop an alien from assassinating his friend Agent K and changing history.", 0.7712380290031433},
			{"Tomorrowland", "Bound by a shared destiny, a teen bursting with scientific curiosity and a former boy-genius inventor embark on a mission to unearth the secrets of a place somewhere in time and space that exists in their collective memory.", 0.7669923901557922},
			{"Love Story 2050", "With the help of his uncle, a man travels to the future to try and bring his girlfriend back to life.", 0.7649372220039368},
			{"The Portal", "A dimension-traveling wizard gets stuck in the 21st century because cell-phone radiation interferes with his magic. With his home world on the brink of war, he seeks help from a jaded ...", 0.7640786170959473},
		}
	} else if os.Getenv("ENV") == "Atlas" {
		expected = []run_queries.ProjectedMovieResult{
			{"Thrill Seekers", "A reporter, learning of time travelers visiting 20th century disasters, tries to change the history they know by averting upcoming disasters.", 0.7892671227455139},
			{"About Time", "At the age of 21, Tim discovers he can travel in time and change what happens and has happened in his own life. His decision to make his world a better place by getting a girlfriend turns out not to be as easy as you might think.", 0.7843604683876038},
			{"The Time Machine", "Hoping to alter the events of the past, a 19th century inventor instead travels 800,000 years into the future, where he finds humankind divided into two warring races.", 0.7801066637039185},
			{"Crusade in Jeans", "After using his mother's newly built time machine, Dolf gets stuck involuntary in the year 1212. He ends up in a children's crusade where he confronts his new friends with modern techniques...", 0.7789170742034912},
			{"Timecop", "An officer for a security agency that regulates time travel, must fend for his life against a shady politician who has a tie to his past.", 0.7771612405776978},
			{"A.P.E.X.", "A time-travel experiment in which a robot probe is sent from the year 2073 to the year 1973 goes terribly wrong thrusting one of the project scientists, a man named Nicholas Sinclair into a...", 0.7730885744094849},
			{"Men in Black 3", "Agent J travels in time to M.I.B.'s early days in 1969 to stop an alien from assassinating his friend Agent K and changing history.", 0.7712380886077881},
			{"Tomorrowland", "Bound by a shared destiny, a teen bursting with scientific curiosity and a former boy-genius inventor embark on a mission to unearth the secrets of a place somewhere in time and space that exists in their collective memory.", 0.7669923901557922},
			{"Love Story 2050", "With the help of his uncle, a man travels to the future to try and bring his girlfriend back to life.", 0.7649372816085815},
			{"The Portal", "A dimension-traveling wizard gets stuck in the 21st century because cell-phone radiation interferes with his magic. With his home world on the brink of war, he seeks help from a jaded ...", 0.7640786170959473},
		}
	} else {
		fmt.Printf("There was no ENV variable set. Ensure your .env file says which environment you're running these tests against.\n")
		t.Fail()
	}
	queryVector := []float64{
		-0.0016261312, -0.028070757, -0.011342932, -0.012775794, -0.0027440966, 0.008683807, -0.02575152, -0.02020668, -0.010283281, -0.0041719596, 0.021392956, 0.028657231, -0.006634482, 0.007490867, 0.018593878, 0.0038187427, 0.029590257, -0.01451522, 0.016061379, 0.00008528442, -0.008943722, 0.01627464, 0.024311995, -0.025911469, 0.00022596726, -0.008863748, 0.008823762, -0.034921836, 0.007910728, -0.01515501, 0.035801545, -0.0035688248, -0.020299982, -0.03145631, -0.032256044, -0.028763862, -0.0071576433, -0.012769129, 0.012322609, -0.006621153, 0.010583182, 0.024085402, -0.001623632, 0.007864078, -0.021406285, 0.002554159, 0.012229307, -0.011762793, 0.0051682983, 0.0048484034, 0.018087378, 0.024325324, -0.037694257, -0.026537929, -0.008803768, -0.017767483, -0.012642504, -0.0062712682, 0.0009771782, -0.010409906, 0.017754154, -0.004671795, -0.030469967, 0.008477209, -0.005218282, -0.0058480743, -0.020153364, -0.0032805866, 0.004248601, 0.0051449724, 0.006791097, 0.007650814, 0.003458861, -0.0031223053, -0.01932697, -0.033615597, 0.00745088, 0.006321252, -0.0038154104, 0.014555207, 0.027697546, -0.02828402, 0.0066711367, 0.0077107945, 0.01794076, 0.011349596, -0.0052715978, 0.014755142, -0.019753495, -0.011156326, 0.011202978, 0.022126047, 0.00846388, 0.030549942, -0.0041386373, 0.018847128, -0.00033655585, 0.024925126, -0.003555496, -0.019300312, 0.010749794, 0.0075308536, -0.018287312, -0.016567878, -0.012869096, -0.015528221, 0.0078107617, -0.011156326, 0.013522214, -0.020646535, -0.01211601, 0.055928253, 0.011596181, -0.017247654, 0.0005939711, -0.026977783, -0.003942035, -0.009583511, -0.0055248477, -0.028737204, 0.023179034, 0.003995351, 0.0219661, -0.008470545, 0.023392297, 0.010469886, -0.015874773, 0.007890735, -0.009690142, -0.00024970944, 0.012775794, 0.0114762215, 0.013422247, 0.010429899, -0.03686786, -0.006717788, -0.027484283, 0.011556195, -0.036068123, -0.013915418, -0.0016327957, 0.0151016945, -0.020473259, 0.004671795, -0.012555866, 0.0209531, 0.01982014, 0.024485271, 0.0105431955, -0.005178295, 0.033162415, -0.013795458, 0.007150979, 0.010243294, 0.005644808, 0.017260984, -0.0045618312, 0.0024725192, 0.004305249, -0.008197301, 0.0014203656, 0.0018460588, 0.005015015, -0.011142998, 0.01439526, 0.022965772, 0.02552493, 0.007757446, -0.0019726837, 0.009503538, -0.032042783, 0.008403899, -0.04609149, 0.013808787, 0.011749465, 0.036388017, 0.016314628, 0.021939443, -0.0250051, -0.017354285, -0.012962398, 0.00006107364, 0.019113706, 0.03081652, -0.018114036, -0.0084572155, 0.009643491, -0.0034721901, 0.0072642746, -0.0090636825, 0.01642126, 0.013428912, 0.027724205, 0.0071243206, -0.6858542, -0.031029783, -0.014595194, -0.011449563, 0.017514233, 0.01743426, 0.009950057, 0.0029706885, -0.015714826, -0.001806072, 0.011856096, 0.026444625, -0.0010663156, -0.006474535, 0.0016161345, -0.020313311, 0.0148351155, -0.0018393943, 0.0057347785, 0.018300641, -0.018647194, 0.03345565, -0.008070676, 0.0071443142, 0.014301958, 0.0044818576, 0.003838736, -0.007350913, -0.024525259, -0.001142124, -0.018620536, 0.017247654, 0.007037683, 0.010236629, 0.06046009, 0.0138887605, -0.012122675, 0.037694257, 0.0055081863, 0.042492677, 0.00021784494, -0.011656162, 0.010276617, 0.022325981, 0.005984696, -0.009496873, 0.013382261, -0.0010563189, 0.0026507939, -0.041639622, 0.008637156, 0.026471283, -0.008403899, 0.024858482, -0.00066686375, -0.0016252982, 0.027590916, 0.0051449724, 0.0058647357, -0.008743787, -0.014968405, 0.027724205, -0.011596181, 0.0047650975, -0.015381602, 0.0043718936, 0.002159289, 0.035908177, -0.008243952, -0.030443309, 0.027564257, 0.042625964, -0.0033688906, 0.01843393, 0.019087048, 0.024578573, 0.03268257, -0.015608194, -0.014128681, -0.0033538956, -0.0028757197, -0.004121976, -0.032389335, 0.0034322033, 0.058807302, 0.010943064, -0.030523283, 0.008903735, 0.017500903, 0.00871713, -0.0029406983, 0.013995391, -0.03132302, -0.019660193, -0.00770413, -0.0038853872, 0.0015894766, -0.0015294964, -0.006251275, -0.021099718, -0.010256623, -0.008863748, 0.028550599, 0.02020668, -0.0012962399, -0.003415542, -0.0022509254, 0.0119360695, 0.027590916, -0.046971202, -0.0015194997, -0.022405956, 0.0016677842, -0.00018535563, -0.015421589, -0.031802863, 0.03814744, 0.0065411795, 0.016567878, -0.015621523, 0.022899127, -0.011076353, 0.02841731, -0.002679118, -0.002342562, 0.015341615, 0.01804739, -0.020566562, -0.012989056, -0.002990682, 0.01643459, 0.00042527664, 0.008243952, -0.013715484, -0.004835075, -0.009803439, 0.03129636, -0.021432944, 0.0012087687, -0.015741484, -0.0052016205, 0.00080890034, -0.01755422, 0.004811749, -0.017967418, -0.026684547, -0.014128681, 0.0041386373, -0.013742141, -0.010056688, -0.013268964, -0.0110630235, -0.028337335, 0.015981404, -0.00997005, -0.02424535, -0.013968734, -0.028310679, -0.027750863, -0.020699851, 0.02235264, 0.001057985, 0.00081639783, -0.0099367285, 0.013522214, -0.012016043, -0.00086471526, 0.013568865, 0.0019376953, -0.019020405, 0.017460918, -0.023045745, 0.008503866, 0.0064678704, -0.011509543, 0.018727167, -0.003372223, -0.0028690554, -0.0027024434, -0.011902748, -0.012182655, -0.015714826, -0.0098634185, 0.00593138, 0.018753825, 0.0010146659, 0.013029044, 0.0003521757, -0.017620865, 0.04102649, 0.00552818, 0.024485271, -0.009630162, -0.015608194, 0.0006718621, -0.0008418062, 0.012395918, 0.0057980907, 0.016221326, 0.010616505, 0.004838407, -0.012402583, 0.019900113, -0.0034521967, 0.000247002, -0.03153628, 0.0011038032, -0.020819811, 0.016234655, -0.00330058, -0.0032289368, 0.00078973995, -0.021952773, -0.022459272, 0.03118973, 0.03673457, -0.021472929, 0.0072109587, -0.015075036, 0.004855068, -0.0008151483, 0.0069643734, 0.010023367, -0.010276617, -0.023019087, 0.0068244194, -0.0012520878, -0.0015086699, 0.022046074, -0.034148756, -0.0022192693, 0.002427534, -0.0027124402, 0.0060346797, 0.015461575, 0.0137554705, 0.009230294, -0.009583511, 0.032629255, 0.015994733, -0.019167023, -0.009203636, 0.03393549, -0.017274313, -0.012042701, -0.0009930064, 0.026777849, -0.013582194, -0.0027590916, -0.017594207, -0.026804507, -0.0014236979, -0.022032745, 0.0091236625, -0.0042419364, -0.00858384, -0.0033905501, -0.020739838, 0.016821127, 0.022539245, 0.015381602, 0.015141681, 0.028817179, -0.019726837, -0.0051283115, -0.011489551, -0.013208984, -0.0047017853, -0.0072309524, 0.01767418, 0.0025658219, -0.010323267, 0.012609182, -0.028097415, 0.026871152, -0.010276617, 0.021912785, 0.0022542577, 0.005124979, -0.0019710176, 0.004518512, -0.040360045, 0.010969722, -0.0031539614, -0.020366628, -0.025778178, -0.0110030435, -0.016221326, 0.0036587953, 0.016207997, 0.003007343, -0.0032555948, 0.0044052163, -0.022046074, -0.0008822095, -0.009363583, 0.028230704, -0.024538586, 0.0029840174, 0.0016044717, -0.014181997, 0.031349678, -0.014381931, -0.027750863, 0.02613806, 0.0004136138, -0.005748107, -0.01868718, -0.0010138329, 0.0054348772, 0.010703143, -0.003682121, 0.0030856507, -0.004275259, -0.010403241, 0.021113047, -0.022685863, -0.023032416, 0.031429652, 0.001792743, -0.005644808, -0.011842767, -0.04078657, -0.0026874484, 0.06915057, -0.00056939584, -0.013995391, 0.010703143, -0.013728813, -0.022939114, -0.015261642, -0.022485929, 0.016807798, 0.007964044, 0.0144219175, 0.016821127, 0.0076241563, 0.005461535, -0.013248971, 0.015301628, 0.0085171955, -0.004318578, 0.011136333, -0.0059047225, -0.010249958, -0.018207338, 0.024645219, 0.021752838, 0.0007614159, -0.013648839, 0.01111634, -0.010503208, -0.0038487327, -0.008203966, -0.00397869, 0.0029740208, 0.008530525, 0.005261601, 0.01642126, -0.0038753906, -0.013222313, 0.026537929, 0.024671877, -0.043505676, 0.014195326, 0.024778508, 0.0056914594, -0.025951454, 0.017620865, -0.0021359634, 0.008643821, 0.021299653, 0.0041686273, -0.009017031, 0.04044002, 0.024378639, -0.027777521, -0.014208655, 0.0028623908, 0.042119466, 0.005801423, -0.028124074, -0.03129636, 0.022139376, -0.022179363, -0.04067994, 0.013688826, 0.013328944, 0.0046184794, -0.02828402, -0.0063412455, -0.0046184794, -0.011756129, -0.010383247, -0.0018543894, -0.0018593877, -0.00052024535, 0.004815081, 0.014781799, 0.018007403, 0.01306903, -0.020433271, 0.009043689, 0.033189073, -0.006844413, -0.019766824, -0.018767154, 0.00533491, -0.0024575242, 0.018727167, 0.0058080875, -0.013835444, 0.0040719924, 0.004881726, 0.012029372, 0.005664801, 0.03193615, 0.0058047553, 0.002695779, 0.009290274, 0.02361889, 0.017834127, 0.0049017193, -0.0036388019, 0.010776452, -0.019793482, 0.0067777685, -0.014208655, -0.024911797, 0.002385881, 0.0034988478, 0.020899786, -0.0025858153, -0.011849431, 0.033189073, -0.021312982, 0.024965113, -0.014635181, 0.014048708, -0.0035921505, -0.003347231, 0.030869836, -0.0017161017, -0.0061346465, 0.009203636, -0.025165047, 0.0068510775, 0.021499587, 0.013782129, -0.0024475274, -0.0051149824, -0.024445284, 0.006167969, 0.0068844, -0.00076183246, 0.030150073, -0.0055948244, -0.011162991, -0.02057989, -0.009703471, -0.020646535, 0.008004031, 0.0066378145, -0.019900113, -0.012169327, -0.01439526, 0.0044252095, -0.004018677, 0.014621852, -0.025085073, -0.013715484, -0.017980747, 0.0071043274, 0.011456228, -0.01010334, -0.0035321703, -0.03801415, -0.012036037, -0.0028990454, -0.05419549, -0.024058744, -0.024272008, 0.015221654, 0.027964126, 0.03182952, -0.015354944, 0.004855068, 0.011522872, 0.004771762, 0.0027874154, 0.023405626, 0.0004242353, -0.03132302, 0.007057676, 0.008763781, -0.0027057757, 0.023005757, -0.0071176565, -0.005238275, 0.029110415, -0.010989714, 0.013728813, -0.009630162, -0.029137073, -0.0049317093, -0.0008630492, -0.015248313, 0.0043219104, -0.0055681667, -0.013175662, 0.029723546, 0.025098402, 0.012849103, -0.0009996708, 0.03118973, -0.0021709518, 0.0260181, -0.020526575, 0.028097415, -0.016141351, 0.010509873, -0.022965772, 0.002865723, 0.0020493253, 0.0020509914, -0.0041419696, -0.00039695262, 0.017287642, 0.0038987163, 0.014795128, -0.014661839, -0.008950386, 0.004431874, -0.009383577, 0.0012604183, -0.023019087, 0.0029273694, -0.033135757, 0.009176978, -0.011023037, -0.002102641, 0.02663123, -0.03849399, -0.0044152127, 0.0004527676, -0.0026924468, 0.02828402, 0.017727496, 0.035135098, 0.02728435, -0.005348239, -0.001467017, -0.019766824, 0.014715155, 0.011982721, 0.0045651635, 0.023458943, -0.0010046692, -0.0031373003, -0.0006972704, 0.0019043729, -0.018967088, -0.024311995, 0.0011546199, 0.007977373, -0.004755101, -0.010016702, -0.02780418, -0.004688456, 0.013022379, -0.005484861, 0.0017227661, -0.015394931, -0.028763862, -0.026684547, 0.0030589928, -0.018513903, 0.028363993, 0.0044818576, -0.009270281, 0.038920518, -0.016008062, 0.0093902415, 0.004815081, -0.021059733, 0.01451522, -0.0051583014, 0.023765508, -0.017874114, -0.016821127, -0.012522544, -0.0028390652, 0.0040886537, 0.020259995, -0.031216389, -0.014115352, -0.009176978, 0.010303274, 0.020313311, 0.0064112223, -0.02235264, -0.022872468, 0.0052449396, 0.0005723116, 0.0037321046, 0.016807798, -0.018527232, -0.009303603, 0.0024858483, -0.0012662497, -0.007110992, 0.011976057, -0.007790768, -0.042999174, -0.006727785, -0.011829439, 0.007024354, 0.005278262, -0.017740825, -0.0041519664, 0.0085905045, 0.027750863, -0.038387362, 0.024391968, 0.00087721116, 0.010509873, -0.00038508154, -0.006857742, 0.0183273, -0.0037054466, 0.015461575, 0.0017394272, -0.0017944091, 0.014181997, -0.0052682655, 0.009023695, 0.00719763, -0.013522214, 0.0034422, 0.014941746, -0.0016711164, -0.025298337, -0.017634194, 0.0058714002, -0.005321581, 0.017834127, 0.0110630235, -0.03369557, 0.029190388, -0.008943722, 0.009363583, -0.0034222065, -0.026111402, -0.007037683, -0.006561173, 0.02473852, -0.007084334, -0.010110005, -0.008577175, 0.0030439978, -0.022712521, 0.0054582027, -0.0012620845, -0.0011954397, -0.015741484, 0.0129557345, -0.00042111133, 0.00846388, 0.008930393, 0.016487904, 0.010469886, -0.007917393, -0.011762793, -0.0214596, 0.000917198, 0.021672864, 0.010269952, -0.007737452, -0.010243294, -0.0067244526, -0.015488233, -0.021552904, 0.017127695, 0.011109675, 0.038067464, 0.00871713, -0.0025591573, 0.021312982, -0.006237946, 0.034628596, -0.0045251767, 0.008357248, 0.020686522, 0.0010696478, 0.0076708077, 0.03772091, -0.018700508, -0.0020676525, -0.008923728, -0.023298996, 0.018233996, -0.010256623, 0.0017860786, 0.009796774, -0.00897038, -0.01269582, -0.018527232, 0.009190307, -0.02372552, -0.042119466, 0.008097334, -0.0066778013, -0.021046404, 0.0019593548, 0.011083017, -0.0016028056, 0.012662497, -0.000059095124, 0.0071043274, -0.014675168, 0.024831824, -0.053582355, 0.038387362, 0.0005698124, 0.015954746, 0.021552904, 0.031589597, -0.009230294, -0.0006147976, 0.002625802, -0.011749465, -0.034362018, -0.0067844326, -0.018793812, 0.011442899, -0.008743787, 0.017474247, -0.021619547, 0.01831397, -0.009037024, -0.0057247817, -0.02728435, 0.010363255, 0.034415334, -0.024032086, -0.0020126705, -0.0045518344, -0.019353628, -0.018340627, -0.03129636, -0.0034038792, -0.006321252, -0.0016161345, 0.033642255, -0.000056075285, -0.005005019, 0.004571828, -0.0024075406, -0.00010215386, 0.0098634185, 0.1980148, -0.003825407, -0.025191706, 0.035161756, 0.005358236, 0.025111731, 0.023485601, 0.0023342315, -0.011882754, 0.018287312, -0.0068910643, 0.003912045, 0.009243623, -0.001355387, -0.028603915, -0.012802451, -0.030150073, -0.014795128, -0.028630573, -0.0013487226, 0.002667455, 0.00985009, -0.0033972147, -0.021486258, 0.009503538, -0.017847456, 0.013062365, -0.014341944, 0.005078328, 0.025165047, -0.015594865, -0.025924796, -0.0018177348, 0.010996379, -0.02993681, 0.007324255, 0.014475234, -0.028577257, 0.005494857, 0.00011725306, -0.013315615, 0.015941417, 0.009376912, 0.0025158382, 0.008743787, 0.023832154, -0.008084005, -0.014195326, -0.008823762, 0.0033455652, -0.032362677, -0.021552904, -0.0056081535, 0.023298996, -0.025444955, 0.0097301295, 0.009736794, 0.015274971, -0.0012937407, -0.018087378, -0.0039387033, 0.008637156, -0.011189649, -0.00023846315, -0.011582852, 0.0066411467, -0.018220667, 0.0060846633, 0.0376676, -0.002709108, 0.0072776037, 0.0034188742, -0.010249958, -0.0007747449, -0.00795738, -0.022192692, 0.03910712, 0.032122757, 0.023898797, 0.0076241563, -0.007397564, -0.003655463, 0.011442899, -0.014115352, -0.00505167, -0.031163072, 0.030336678, -0.006857742, -0.022259338, 0.004048667, 0.02072651, 0.0030156737, -0.0042119464, 0.00041861215, -0.005731446, 0.011103011, 0.013822115, 0.021512916, 0.009216965, -0.006537847, -0.027057758, -0.04054665, 0.010403241, -0.0056281467, -0.005701456, -0.002709108, -0.00745088, -0.0024841821, 0.009356919, -0.022659205, 0.004061996, -0.013175662, 0.017074378, -0.006141311, -0.014541878, 0.02993681, -0.00028448965, -0.025271678, 0.011689484, -0.014528549, 0.004398552, -0.017274313, 0.0045751603, 0.012455898, 0.004121976, -0.025458284, -0.006744446, 0.011822774, -0.015035049, -0.03257594, 0.014675168, -0.0039187097, 0.019726837, -0.0047251107, 0.0022825818, 0.011829439, 0.005391558, -0.016781142, -0.0058747325, 0.010309938, -0.013049036, 0.01186276, -0.0011246296, 0.0062112883, 0.0028190718, -0.021739509, 0.009883412, -0.0073175905, -0.012715813, -0.017181009, -0.016607866, -0.042492677, -0.0014478565, -0.01794076, 0.012302616, -0.015194997, -0.04433207, -0.020606548, 0.009696807, 0.010303274, -0.01694109, -0.004018677, 0.019353628, -0.001991011, 0.000058938927, 0.010536531, -0.17274313, 0.010143327, 0.014235313, -0.024152048, 0.025684876, -0.0012504216, 0.036601283, -0.003698782, 0.0007310093, 0.004165295, -0.0029157067, 0.017101036, -0.046891227, -0.017460918, 0.022965772, 0.020233337, -0.024072073, 0.017220996, 0.009370248, 0.0010363255, 0.0194336, -0.019606877, 0.01818068, -0.020819811, 0.007410893, 0.0019326969, 0.017887443, 0.006651143, 0.00067394477, -0.011889419, -0.025058415, -0.008543854, 0.021579562, 0.0047484366, 0.014062037, 0.0075508473, -0.009510202, -0.009143656, 0.0046817916, 0.013982063, -0.0027990784, 0.011782787, 0.014541878, -0.015701497, -0.029350337, 0.021979429, 0.01332228, -0.026244693, -0.0123492675, -0.003895384, 0.0071576433, -0.035454992, -0.00046984528, 0.0033522295, 0.039347045, 0.0005119148, 0.00476843, -0.012995721, 0.0024042083, -0.006931051, -0.014461905, -0.0127558, 0.0034555288, -0.0074842023, -0.030256703, -0.007057676, -0.00807734, 0.007804097, -0.006957709, 0.017181009, -0.034575284, -0.008603834, -0.005008351, -0.015834786, 0.02943031, 0.016861115, -0.0050849924, 0.014235313, 0.0051449724, 0.0025924798, -0.0025741523, 0.04289254, -0.002104307, 0.012969063, -0.008310596, 0.00423194, 0.0074975314, 0.0018810473, -0.014248641, -0.024725191, 0.0151016945, -0.017527562, 0.0018727167, 0.0002830318, 0.015168339, 0.0144219175, -0.004048667, -0.004358565, 0.011836103, -0.010343261, -0.005911387, 0.0022825818, 0.0073175905, 0.00403867, 0.013188991, 0.03334902, 0.006111321, 0.008597169, 0.030123414, -0.015474904, 0.0017877447, -0.024551915, 0.013155668, 0.023525586, -0.0255116, 0.017220996, 0.004358565, -0.00934359, 0.0099967085, 0.011162991, 0.03092315, -0.021046404, -0.015514892, 0.0011946067, -0.01816735, 0.010876419, -0.10124666, -0.03550831, 0.0056348112, 0.013942076, 0.005951374, 0.020419942, -0.006857742, -0.020873128, -0.021259667, 0.0137554705, 0.0057880944, -0.029163731, -0.018767154, -0.021392956, 0.030896494, -0.005494857, -0.0027307675, -0.006801094, -0.014821786, 0.021392956, -0.0018110704, -0.0018843795, -0.012362596, -0.0072176233, -0.017194338, -0.018713837, -0.024272008, 0.03801415, 0.00015880188, 0.0044951867, -0.028630573, -0.0014070367, -0.00916365, -0.026537929, -0.009576847, -0.013995391, -0.0077107945, 0.0050016865, 0.00578143, -0.04467862, 0.008363913, 0.010136662, -0.0006268769, -0.006591163, 0.015341615, -0.027377652, -0.00093136, 0.029243704, -0.020886457, -0.01041657, -0.02424535, 0.005291591, -0.02980352, -0.009190307, 0.019460259, -0.0041286405, 0.004801752, 0.0011787785, -0.001257086, -0.011216307, -0.013395589, 0.00088137644, -0.0051616337, 0.03876057, -0.0033455652, 0.00075850025, -0.006951045, -0.0062112883, 0.018140694, -0.006351242, -0.008263946, 0.018154023, -0.012189319, 0.0075508473, -0.044358727, -0.0040153447, 0.0093302615, -0.010636497, 0.032789204, -0.005264933, -0.014235313, -0.018393943, 0.007297597, -0.016114693, 0.015021721, 0.020033404, 0.0137688, 0.0011046362, 0.010616505, -0.0039453674, 0.012109346, 0.021099718, -0.0072842683, -0.019153694, -0.003768759, 0.039320387, -0.006747778, -0.0016852784, 0.018154023, 0.0010963057, -0.015035049, -0.021033075, -0.04345236, 0.017287642, 0.016341286, -0.008610498, 0.00236922, 0.009290274, 0.028950468, -0.014475234, -0.0035654926, 0.015434918, -0.03372223, 0.004501851, -0.012929076, -0.008483873, -0.0044685286, -0.0102233, 0.01615468, 0.0022792495, 0.010876419, -0.0059647025, 0.01895376, -0.0069976957, -0.0042952523, 0.017207667, -0.00036133936, 0.0085905045, 0.008084005, 0.03129636, -0.016994404, -0.014915089, 0.020100048, -0.012009379, -0.006684466, 0.01306903, 0.00015765642, -0.00530492, 0.0005277429, 0.015421589, 0.015528221, 0.032202728, -0.003485519, -0.0014286962, 0.033908837, 0.001367883, 0.010509873, 0.025271678, -0.020993087, 0.019846799, 0.006897729, -0.010216636, -0.00725761, 0.01818068, -0.028443968, -0.011242964, -0.014435247, -0.013688826, 0.006101324, -0.0022509254, 0.013848773, -0.0019077052, 0.017181009, 0.03422873, 0.005324913, -0.0035188415, 0.014128681, -0.004898387, 0.005038341, 0.0012320944, -0.005561502, -0.017847456, 0.0008538855, -0.0047884234, 0.011849431, 0.015421589, -0.013942076, 0.0029790192, -0.013702155, 0.0001199605, -0.024431955, 0.019926772, 0.022179363, -0.016487904, -0.03964028, 0.0050849924, 0.017487574, 0.022792496, 0.0012504216, 0.004048667, -0.00997005, 0.0076041627, -0.014328616, -0.020259995, 0.0005598157, -0.010469886, 0.0016852784, 0.01716768, -0.008990373, -0.001987679, 0.026417969, 0.023792166, 0.0046917885, -0.0071909656, -0.00032051947, -0.023259008, -0.009170313, 0.02071318, -0.03156294, -0.030869836, -0.006324584, 0.013795458, -0.00047151142, 0.016874444, 0.00947688, 0.00985009, -0.029883493, 0.024205362, -0.013522214, -0.015075036, -0.030603256, 0.029270362, 0.010503208, 0.021539574, 0.01743426, -0.023898797, 0.022019416, -0.0068777353, 0.027857494, -0.021259667, 0.0025758184, 0.006197959, 0.006447877, -0.00025200035, -0.004941706, -0.021246338, -0.005504854, -0.008390571, -0.0097301295, 0.027244363, -0.04446536, 0.05216949, 0.010243294, -0.016008062, 0.0122493, -0.0199401, 0.009077012, 0.019753495, 0.006431216, -0.037960835, -0.027377652, 0.016381273, -0.0038620618, 0.022512587, -0.010996379, -0.0015211658, -0.0102233, 0.007071005, 0.008230623, -0.009490209, -0.010083347, 0.024431955, 0.002427534, 0.02828402, 0.0035721571, -0.022192692, -0.011882754, 0.010056688, 0.0011904413, -0.01426197, -0.017500903, -0.00010985966, 0.005591492, -0.0077707744, -0.012049366, 0.011869425, 0.00858384, -0.024698535, -0.030283362, 0.020140035, 0.011949399, -0.013968734, 0.042732596, -0.011649498, -0.011982721, -0.016967745, -0.0060913274, -0.007130985, -0.013109017, -0.009710136,
	}

	vectorSearchStage := bson.D{
		{"$vectorSearch", bson.D{
			{"index", "vector_index"},
			{"path", "plot_embedding"},
			{"queryVector", queryVector},
			{"numCandidates", 150},
			{"limit", 10},
		}}}

	projectStage := bson.D{
		{"$project", bson.D{
			{"_id", 0},
			{"plot", 1},
			{"title", 1},
			{"score", bson.D{{"$meta", "vectorSearchScore"}}},
		}}}

	scenario := run_queries.AnnBasicScenario{
		Database:          "sample_mflix",
		Collection:        "embedded_movies",
		Embedding:         queryVector,
		VectorSearchStage: vectorSearchStage,
		ProjectStage:      projectStage,
		Expected:          expected,
		Testing:           t,
	}

	if len(scenario.Expected) == 0 {
		fmt.Printf("The scenario has no expected results, so the test will fail. Don't bother to run the test.\n")
		t.Fail()
	}

	manage_indexes.ExampleCreateIndexBasic(t)
	run_queries.ExampleAnnBasicQueryWithScenario(scenario)

	// Drop the index to clear state for future tests
	manage_indexes.ExampleDropIndex()
}

func TestAnnQueryWithFilter(t *testing.T) {
	var expected []run_queries.ProjectedMovieResultWithFilter
	/* Note: we are maintaining different expectations for Atlas and local deployments because not all of the scores match
	 * There are the following discrepancies between scores:
	 * That Man from Rio: Atlas: 0.7416020035743713 Local: 0.7416019439697266
	 * Willy Wonka & the Chocolate Factory: Atlas: 0.7342107892036438 Local: 0.7342106699943542
	 * Bedknobs and Broomsticks: Atlas: 0.7339356541633606 Local: 0.7339357137680054
	 * Pastoral Hide and Seek: Atlas: 0.733299970626831 Local: 0.7332999110221863
	 * The Three Musketeers: Atlas: 0.7331198453903198 Local: 0.733119785785675
	 */
	if err := godotenv.Load("../../.env"); err != nil {
		log.Println("no .env file found")
	}
	if os.Getenv("ENV") == "local" {
		expected = []run_queries.ProjectedMovieResultWithFilter{
			{"Peter Pan", "In this magical tale about the boy who refuses to grow up, Peter Pan and his mischievous fairy sidekick Tinkerbell visit the nursery of Wendy, Michael, and John Darling. With a sprinkling ...", 1960, 0.748110830783844},
			{"Chitty Chitty Bang Bang", "A down-on-his-luck inventor turns a broken-down Grand Prix car into a fancy vehicle for his children, and then they go off on a magical fantasy adventure to save their grandfather in a far-off land.", 1968, 0.7442465424537659},
			{"That Man from Rio", "A young man comes to the rescue of his girlfriend abducted by thieves and brought to Rio. An extravagant adventure ensues.", 1964, 0.7416019439697266},
			{"The Little Prince", "A pilot, stranded in the desert, meets a little boy who is a prince on a planet.", 1974, 0.7378944158554077},
			{"The Red Balloon", "A red balloon with a life of its own follows a little boy around the streets of Paris.", 1956, 0.7342712879180908},
			{"Willy Wonka & the Chocolate Factory", "A poor boy wins the opportunity to tour the most eccentric and wonderful candy factory of all.", 1971, 0.7342106699943542},
			{"Bedknobs and Broomsticks", "An apprentice witch, three kids and a cynical conman search for the missing component to a magic spell useful to the defense of Britain.", 1971, 0.7339357137680054},
			{"Pastoral Hide and Seek", "A young boys' coming of age tale set in a strange, carnivalesque village becomes the recreation of a memory that the director has twenty years later.", 1974, 0.7332999110221863},
			{"The Three Musketeers", "A young swordsman comes to Paris and faces villains, romance, adventure and intrigue with three Musketeer friends.", 1973, 0.733119785785675},
			{"Frosty", "A fairy-tale about a conceited young man and a young woman with a tyrannical step-mother, who must overcome magical trials in order to be together.", 1964, 0.7318308353424072},
		}
	} else if os.Getenv("ENV") == "Atlas" {
		expected = []run_queries.ProjectedMovieResultWithFilter{
			{"Peter Pan", "In this magical tale about the boy who refuses to grow up, Peter Pan and his mischievous fairy sidekick Tinkerbell visit the nursery of Wendy, Michael, and John Darling. With a sprinkling ...", 1960, 0.748110830783844},
			{"Chitty Chitty Bang Bang", "A down-on-his-luck inventor turns a broken-down Grand Prix car into a fancy vehicle for his children, and then they go off on a magical fantasy adventure to save their grandfather in a far-off land.", 1968, 0.7442465424537659},
			{"That Man from Rio", "A young man comes to the rescue of his girlfriend abducted by thieves and brought to Rio. An extravagant adventure ensues.", 1964, 0.7416020035743713},
			{"The Little Prince", "A pilot, stranded in the desert, meets a little boy who is a prince on a planet.", 1974, 0.7378944158554077},
			{"The Red Balloon", "A red balloon with a life of its own follows a little boy around the streets of Paris.", 1956, 0.7342712879180908},
			{"Willy Wonka & the Chocolate Factory", "A poor boy wins the opportunity to tour the most eccentric and wonderful candy factory of all.", 1971, 0.7342107892036438},
			{"Bedknobs and Broomsticks", "An apprentice witch, three kids and a cynical conman search for the missing component to a magic spell useful to the defense of Britain.", 1971, 0.7339356541633606},
			{"Pastoral Hide and Seek", "A young boys' coming of age tale set in a strange, carnivalesque village becomes the recreation of a memory that the director has twenty years later.", 1974, 0.733299970626831},
			{"The Three Musketeers", "A young swordsman comes to Paris and faces villains, romance, adventure and intrigue with three Musketeer friends.", 1973, 0.7331198453903198},
			{"Frosty", "A fairy-tale about a conceited young man and a young woman with a tyrannical step-mother, who must overcome magical trials in order to be together.", 1964, 0.7318308353424072},
		}
	} else {
		fmt.Printf("There was no ENV variable set. Ensure your .env file says which environment you're running these tests against.\n")
		t.FailNow()
	}

	queryVector := []float64{
		0.02421053, -0.022372592, -0.006231137, -0.02168502, -0.020375984, 0.037552103, -0.010505334, -0.027026938, 0.0070674648, -0.020032197, 0.01783725, 0.016303431, 0.014584498, -0.018736385, 0.009031017, -0.0045981496, 0.02750295, -0.028322749, 0.010624337, -0.024236975, -0.0048659067, 0.015153068, -0.000490888, -0.022161031, -0.0024560927, -0.007411252, 0.009745035, -0.01886861, 0.02112967, -0.011939983, 0.015153068, 0.0025800543, 0.017824028, -0.02410475, -0.016633997, -0.0018214093, -0.008323609, -0.009222744, 0.009388026, -0.0028296304, 0.0017536436, 0.0065517845, -0.011635863, -0.028454976, -0.018934723, 0.012951509, -0.0032015154, -0.005880739, -0.03115238, 0.012951509, 0.0057749585, 0.009202911, -0.0069352393, 0.00205611, 0.0063732797, 0.0039700773, -0.007100521, -0.0077087595, 0.011596196, -0.010207825, -0.007100521, -0.0051006074, -0.01670011, 0.012773004, -0.035304267, -0.0074971984, 0.0025800543, -0.006118745, 0.030253245, -0.0010751605, 0.039456155, 0.007821151, -0.0017189344, -0.0010801188, 0.0062575825, -0.011490415, -0.022637043, 0.004743598, -0.012601111, 0.0197413, -0.0015255542, -0.025942687, -0.03284487, 0.020389207, 0.009797926, 0.0141217075, -0.0015172901, 0.025982354, -0.011589585, -0.001138794, 0.0006131968, 0.016832335, 0.017916586, 0.014412603, -0.0027155858, 0.011854036, -0.02169824, 0.02112967, -0.020680103, -0.007391418, -0.012872174, 0.021473458, 0.0047766543, -0.0048394613, -0.024395647, 0.0065418677, 0.009797926, -0.00449898, 0.041836217, 0.0023833686, -0.021737909, 0.0136721395, 0.014148152, -0.028772317, -0.027899627, -0.015695194, -0.012521776, 0.02205525, -0.01927851, -0.022068473, 0.020971, 0.02317917, 0.030544141, -0.011827591, 0.0075170323, 0.023086611, -0.02164535, -0.01732157, 0.007510421, -0.027635176, 0.016263764, -0.0008801275, 0.033109322, -0.014505162, -0.029909458, 0.036679417, 0.0074971984, 0.0059137954, -0.031178825, -0.012634167, 0.008416167, 0.030491251, -0.016832335, -0.009507029, 0.010016099, 0.009778093, 0.007840985, 0.010928456, -0.009685534, -0.027661622, 0.024752656, -0.024871659, 0.01516629, 0.002778393, 0.0059501575, 0.022042029, 0.0005441915, 0.0076889256, -0.009883873, -0.019966085, 0.008508725, 0.0098045375, 0.0091169635, -0.02750295, 0.012501942, 0.03480181, 0.021751132, 0.020746216, 0.003546955, -0.014690278, 0.010445832, 0.008469057, -0.00007535833, 0.0059600743, -0.013526691, 0.029539226, -0.011126795, 0.025400562, -0.025466675, -0.0046080663, -0.013923368, -0.009011183, 0.019318178, 0.019053727, -0.012085431, -0.0074707535, 0.0013024234, 0.0076624807, 0.0060460214, -0.0023007276, 0.017757915, 0.031258162, 0.0008768218, -0.003695709, -0.6981518, -0.012058986, 0.008931847, -0.02914255, 0.00833022, 0.028349195, 0.013857256, 0.0029668147, -0.008164939, -0.001494977, -0.0011197866, 0.0104855, 0.014610942, -0.0066608707, 0.000643774, 0.0020676798, 0.008607894, -0.023787407, 0.020494986, 0.015443964, -0.019833859, 0.012905231, 0.013387854, -0.020918109, 0.0035800114, 0.026775708, 0.005920407, -0.018233927, -0.008759954, 0.0005437783, -0.022081695, 0.0071996907, -0.002963509, 0.004092386, 0.057967756, -0.015285294, -0.008978127, 0.027740957, 0.015853863, 0.047178138, -0.018366152, -0.0064889775, 0.029777233, 0.0141217075, 0.007847597, 0.02200236, 0.031125935, 0.010611114, -0.00663112, -0.005940241, 0.017215788, -0.019992528, -0.01644888, -0.013447356, 0.001490845, 0.007893875, 0.016276987, -0.0062939445, 0.00032333322, 0.0020230536, -0.025360893, 0.028587202, -0.009645866, 0.01459772, -0.012376328, 0.03202507, -0.006059244, 0.010888788, 0.014518384, -0.034405135, 0.023364285, 0.018895056, -0.009361581, -0.0011255714, 0.00663112, 0.016885225, 0.01609187, -0.006750123, -0.035304267, 0.0022660184, 0.027714511, 0.01680589, -0.03686453, -0.008045935, 0.052943178, -0.0091169635, -0.0066840104, 0.018405821, 0.00027374856, 0.0005235312, 0.0138969235, 0.018075256, 0.0005850988, -0.0074971984, 0.0011255714, -0.011054071, -0.0022048638, 0.0043931995, 0.021142893, -0.02472621, -0.007232747, 0.0014858865, -0.00062228733, -0.017903363, -0.0013495288, -0.0001454483, 0.0027370725, 0.0060129645, 0.0364943, -0.04601455, -0.008713675, -0.017215788, -0.017784359, -0.007100521, -0.014610942, -0.027978962, 0.0046179835, -0.010267328, 0.036785197, -0.019542962, 0.028719427, 0.004343615, 0.0067765685, -0.018075256, -0.004462618, 0.010121879, -0.0024957606, -0.00883929, 0.0017007533, -0.011371412, -0.007788095, 0.002418078, -0.01053839, -0.018458711, -0.0048328503, 0.0035072872, 0.0043568374, -0.006389808, 0.027635176, -0.002768476, -0.033479553, -0.0069749067, -0.00096276856, -0.0034048124, 0.012773004, -0.01979419, -0.003675875, -0.011655698, -0.026709596, -0.0009206216, -0.009295468, 0.011391246, 0.0050510224, 0.0027486421, 0.0024246892, -0.01264739, 0.004687402, -0.0058377655, 0.0117945345, -0.009388026, 0.010545001, 0.020481765, -0.000089768866, -0.022425482, -0.013487023, -0.008316998, -0.019503294, 0.025942687, 0.0076889256, -0.03355889, -0.0071071326, -0.019106617, -0.015430742, 0.021724686, 0.0019652047, 0.011113572, -0.019410737, -0.023615515, 0.000523118, 0.019027282, -0.015853863, -0.011887092, -0.021804022, -0.013473801, -0.0049518533, -0.00071773777, -0.003194904, 0.046411227, -0.0108689545, 0.04003795, -0.0026626955, 0.03146972, -0.005804709, -0.013645695, 0.0046973187, -0.010148324, 0.02292794, 0.0310466, 0.018709939, 0.020005751, 0.028534312, -0.02134123, 0.044031166, -0.00021548661, 0.018458711, -0.038795028, -0.00930208, -0.013738252, 0.029486336, -0.0019503294, 0.008812845, -0.02755584, 0.004852684, -0.013301908, 0.000006940559, 0.017453795, -0.005249361, 0.0069352393, -0.023205614, -0.02040243, -0.0060493266, -0.017110009, 0.011417692, 0.006882349, -0.019556185, 0.015893532, -0.0028874793, -0.0023387424, -0.0034610082, -0.009427694, -0.009705368, 0.002194947, -0.008191383, 0.021804022, -0.016250541, 0.0053320024, 0.037393436, -0.014174597, 0.031073045, 0.004108914, 0.010029321, 0.018538047, 0.007675703, -0.012568055, -0.0080525465, 0.0013487024, 0.03234241, -0.009983042, -0.014782836, 0.0069418503, -0.014346491, -0.0009875608, -0.024924548, 0.035145596, 0.009592976, -0.010902011, 0.0047568204, 0.006194775, 0.011344967, 0.028349195, 0.0062410543, -0.0027172386, 0.011080516, 0.012303604, 0.012263936, -0.009844205, -0.004766737, -0.0062079974, -0.005748513, -0.01979419, -0.006036104, -0.018630605, -0.00050204457, -0.013830811, 0.0015338184, -0.00418825, -0.020799106, -0.016792666, -0.0034015067, 0.034352243, 0.00915002, -0.019767746, 0.016462103, 0.014346491, -0.009672312, -0.032606862, -0.010035932, -0.0035238154, -0.018934723, 0.012204434, -0.015946422, 0.022597376, -0.00081194856, 0.002740378, 0.0088921795, 0.0056361216, 0.011549917, -0.0088789575, 0.008720286, 0.007424474, -0.0022263506, 0.0020131366, -0.023165947, -0.037181873, 0.014756391, 0.011424302, -0.0057385964, -0.014690278, -0.018709939, -0.005536952, -0.0064228643, 0.00418825, -0.023787407, 0.012845729, -0.009487196, -0.011754867, -0.008746731, -0.013844033, 0.026643483, 0.009070684, -0.016554661, -0.024078304, -0.013553137, 0.011146628, 0.11075226, -0.007854208, 0.0024098137, 0.005685706, 0.0032081266, -0.00603941, -0.022161031, 0.0004933672, 0.0014486981, -0.001134662, 0.007345139, 0.008237663, -0.0019057032, 0.007120355, -0.009864039, 0.03115238, -0.00041051954, -0.00344448, -0.013063901, -0.020997444, 0.013222572, -0.002824672, 0.018366152, 0.025889797, 0.007523644, -0.019648742, -0.007391418, 0.02168502, -0.0019255371, -0.018524824, -0.00021156116, -0.004826239, -0.001088383, -0.0071468004, 0.0000106013, -0.002963509, 0.015430742, 0.029036768, 0.035806727, -0.016924892, 0.039271038, 0.02503033, 0.019648742, -0.02636581, 0.0035634832, -0.00044254295, -0.016435657, 0.012792839, 0.008270719, -0.03469603, 0.052599393, 0.008270719, -0.0052824174, -0.0059534633, 0.023668405, 0.011159851, -0.018128147, -0.0064856717, 0.009606198, -0.015258849, 0.00291723, -0.028851653, 0.019133061, -0.012323437, -0.01516629, -0.027846737, -0.019820636, 0.0024974134, -0.01377792, -0.00067063235, -0.022703156, -0.009156631, -0.012303604, -0.023311395, 0.006174941, 0.0073980293, 0.012343272, -0.015721638, -0.00033097752, 0.019146284, 0.011761478, -0.019542962, -0.0057452074, -0.0076823146, -0.002343701, 0.007840985, 0.014941507, 0.007847597, -0.004029579, 0.008812845, 0.029168995, 0.01876283, 0.01125902, -0.010611114, 0.00021734604, -0.0037948783, -0.0016445575, 0.028587202, 0.015086955, 0.0035899284, 0.0009900401, -0.019622298, -0.00704102, -0.0062410543, 0.0027106274, 0.009652478, -0.01573486, 0.0152985165, 0.0046774847, -0.02595591, 0.0115565285, -0.021989137, 0.010961512, -0.011179685, 0.011781312, -0.00055782724, -0.0033238241, -0.0012619293, 0.02066688, -0.014372936, 0.006399725, -0.022332925, 0.011014403, 0.01927851, -0.008733509, 0.003798184, 0.017744692, -0.036732305, 0.0077087595, 0.005454311, -0.0038676024, 0.01696456, -0.00037973575, 0.0058212373, -0.030517697, -0.012006096, 0.012482109, 0.015946422, 0.0031899456, 0.001283416, -0.0055898423, 0.01737446, 0.03633563, 0.015642302, -0.002953592, -0.02446176, -0.011364801, -0.023033721, -0.003798184, 0.03726121, -0.021513125, 0.014505162, -0.008971515, -0.0023007276, 0.0009231008, -0.03916526, -0.023364285, 0.008145104, 0.020997444, 0.025889797, 0.0302268, -0.02107678, 0.03720832, -0.009936763, 0.013361409, -0.00080492406, -0.015972868, -0.0035172042, -0.041968442, 0.012369717, 0.020389207, 0.011530083, 0.0016420782, -0.026947603, 0.010465666, 0.009983042, 0.011549917, -0.013923368, -0.0075699226, -0.012442441, 0.0031635005, -0.0003237464, -0.009196299, 0.007920321, -0.003556872, 0.0043105586, 0.036520746, 0.0029155773, -0.0025073302, -0.016224096, 0.0094541395, -0.016409213, 0.01192676, 0.0008702105, 0.014796059, 0.002148668, -0.013414299, -0.026154248, -0.02235937, 0.011801146, 0.012442441, -0.0016685233, 0.008898791, 0.0063931136, -0.01094829, 0.013963036, 0.002611458, -0.015880309, 0.01789014, -0.0050378, -0.0035800114, -0.016885225, 0.0073120827, -0.040117282, 0.005748513, 0.0027536007, -0.022676712, 0.008674008, -0.024699764, 0.0045783157, -0.030676367, 0.0008602936, 0.038742136, 0.010551613, 0.020812329, 0.0017354626, 0.011278854, -0.0068559037, -0.016686887, -0.007424474, 0.0022759351, 0.014452271, 0.0141217075, 0.0020296648, -0.0016784403, -0.017810805, -0.009526864, -0.015906755, -0.012092043, 0.0143597135, -0.009090519, 0.01352008, -0.012620945, -0.008270719, -0.013288685, 0.027978962, -0.0049882154, -0.0044791466, -0.008726898, -0.015946422, -0.02153957, 0.012938287, -0.016753, 0.022531264, 0.015933199, -0.013361409, 0.03834546, -0.001832979, -0.008773177, -0.012111876, -0.02524189, 0.024792323, 0.009758258, 0.029327665, 0.01141108, 0.01022766, -0.016726553, 0.008409556, 0.011424302, 0.023192393, 0.0021354454, -0.01346719, -0.016435657, 0.0051072184, -0.0037485992, -0.015338183, -0.009374804, -0.02251804, -0.026815377, -0.022703156, 0.01582742, 0.016951337, -0.014491939, -0.011523472, -0.018154591, 0.0061418847, -0.00039378472, -0.009599588, 0.00061898166, -0.026088135, -0.010809453, -0.012680447, 0.0011892051, 0.00817155, -0.011060682, -0.007834374, -0.0015015884, 0.018974392, -0.026379032, 0.01794303, -0.029063214, 0.005731985, -0.015721638, 0.013202738, 0.018855387, -0.017043896, 0.021883357, -0.00976487, -0.0063501406, 0.0006817889, -0.021010667, -0.0034411745, -0.019701632, -0.015999312, -0.0065418677, 0.0036130678, -0.015615858, -0.017519908, -0.035330713, 0.029486336, 0.0007094736, -0.015351406, -0.00010252659, -0.0019618992, 0.02565179, 0.0023751045, 0.024382424, -0.007807929, -0.016157983, -0.008012879, -0.0076823146, 0.020256981, -0.0023784102, -0.01125902, -0.017229011, -0.009163243, -0.0073980293, 0.018802498, 0.0007470753, 0.004786571, 0.038133897, 0.022782492, 0.0136721395, 0.0048394613, -0.00033986144, 0.0070608538, 0.005771653, -0.026167471, -0.021394122, -0.0039237984, 0.01922562, 0.03868925, 0.00899796, -0.021658573, -0.010809453, -0.010604503, -0.011966428, 0.0051733316, 0.003074248, 0.017757915, 0.051620923, 0.0036593468, -0.016673664, 0.013024233, 0.004826239, 0.02750295, -0.00817155, -0.012865563, 0.013037456, 0.01758602, -0.0006045195, 0.010187992, -0.03263331, -0.015814196, 0.029274775, 0.0018957863, -0.009672312, 0.0011966428, -0.015748084, -0.0054972842, -0.041386653, 0.012250713, 0.007530255, 0.0047204583, 0.018286817, -0.02134123, 0.0033915897, -0.007391418, -0.0035304269, -0.0032180436, -0.0002681703, -0.009361581, -0.013249017, 0.02036276, -0.010749951, -0.02107678, -0.017242234, -0.01644888, 0.02483199, -0.0060823835, 0.0042576683, 0.020071864, 0.014372936, -0.013963036, -0.008350055, 0.005474145, -0.0029321054, -0.029512782, -0.023046944, -0.017718246, 0.0016106745, -0.021618906, -0.011490415, -0.009209521, 0.009282245, 0.01459772, 0.024567539, -0.0021073474, 0.02168502, 0.0021040419, -0.025770793, 0.0014296906, 0.0042279176, -0.009553309, -0.0041254424, -0.012396161, 0.0018395904, -0.016753, -0.0076889256, -0.0010991263, -0.022782492, 0.004224612, 0.014518384, 0.015100177, -0.01315646, 0.0036362074, 0.19643453, -0.006902183, -0.01223088, 0.0163431, -0.0065352563, 0.018723162, 0.0247791, -0.0050807735, -0.0047832653, -0.009196299, -0.014928284, 0.027529396, 0.0019933027, 0.0026180693, 0.0016205915, -0.01639599, -0.02153957, -0.017202567, -0.024131194, -0.03316221, -0.00085698796, -0.0063600573, -0.03181351, -0.009037628, 0.0032907678, -0.0050378, -0.0010346663, -0.01835293, 0.01361925, 0.026088135, 0.0005751819, -0.016819112, -0.009434305, 0.0023354369, -0.020997444, -0.0067402064, 0.008310387, 0.0040626354, 0.0040890803, 0.030306136, -0.015959645, 0.021037113, -0.0009916929, 0.0070872987, -0.01161603, 0.017096786, -0.001370189, -0.0042080837, 0.0008140146, 0.014108485, -0.02606169, -0.010472277, 0.021261897, 0.019966085, -0.011735033, -0.010908622, 0.0016586065, 0.029697897, -0.01830004, -0.011034236, -0.0038246291, 0.031787064, -0.0079401545, 0.0075500887, -0.009844205, 0.022161031, -0.0044097276, 0.0059600743, 0.011959816, -0.019371068, 0.0037915725, -0.015020842, -0.010968124, -0.0062741106, -0.00012179228, -0.027053382, 0.03377045, 0.005725374, 0.0026891406, -0.0011602807, -0.00403619, -0.0076889256, 0.0040791635, -0.0040989975, -0.018895056, -0.0197413, 0.014756391, 0.0057914867, -0.012296992, -0.017757915, 0.008422779, -0.020137977, 0.003537038, -0.0011040848, 0.0061286623, 0.031734172, -0.011748255, 0.03207796, 0.008204606, -0.0043270867, -0.02652448, -0.03501337, 0.0050609396, 0.015615858, -0.027476504, 0.0026660012, 0.00057104987, 0.022861827, -0.012098653, -0.0024461758, 0.01022766, -0.008350055, 0.0114441365, 0.0022081695, -0.0044130334, 0.018009143, -0.0013867173, -0.016620774, -0.0060460214, -0.01459772, 0.008164939, -0.013249017, 0.005748513, 0.005232833, -0.024950994, -0.011490415, -0.013480413, 0.021552794, 0.011285465, -0.03604473, 0.0041915555, -0.0052096937, 0.013037456, -0.012449052, -0.013037456, 0.01639599, 0.0051997765, -0.002267671, 0.015047288, 0.018643826, 0.013976259, 0.0052394443, 0.0059534633, 0.010016099, -0.0016528215, -0.03670586, 0.023483288, 0.008250885, -0.0051997765, -0.012607723, -0.019133061, -0.005798098, -0.012991177, -0.001120613, 0.015272071, -0.03279198, -0.040646188, -0.014994397, -0.009031017, 0.014108485, -0.011424302, 0.021420566, 0.0053353077, 0.0052361386, -0.012607723, -0.0076823146, -0.17136453, -0.0011024319, 0.011351578, -0.0062278314, 0.008700453, 0.0017106703, 0.011992873, 0.0048758234, -0.004568399, -0.0052460553, 0.02729139, -0.013407689, -0.041809775, 0.0023552708, 0.025612123, 0.031337496, -0.008925236, 0.017004227, 0.013989481, 0.005252667, 0.02344362, 0.023879966, -0.0006917058, 0.013949813, 0.0005198124, 0.0051072184, 0.0040791635, 0.0046576513, -0.012574666, -0.013698584, -0.012654002, -0.00344448, -0.006862515, 0.012944899, 0.023324618, 0.004743598, -0.029724343, 0.006307167, 0.0016453839, 0.0093549695, -0.008469057, 0.035648055, 0.01454483, -0.0115697505, 0.011344967, 0.015496855, -0.013738252, -0.0026610426, -0.005923712, -0.007953377, 0.01609187, -0.02698727, 0.011483804, -0.014796059, 0.024408868, 0.009778093, -0.0014437396, 0.007001352, 0.022068473, -0.011701977, -0.00007365386, -0.023377508, 0.012964732, -0.010445832, -0.018114924, -0.04009084, -0.0056427326, 0.0071269665, -0.03300354, 0.028666537, -0.025850128, -0.017440572, 0.007966599, -0.026484812, 0.012409384, -0.0022032112, -0.009778093, -0.005798098, -0.015430742, -0.0028775623, -0.011629253, 0.035304267, -0.03295065, 0.019384291, -0.009513641, 0.017387683, -0.019873526, -0.011113572, -0.012052375, -0.010531778, 0.010459054, -0.034458023, -0.01876283, -0.00026589766, 0.008217828, 0.025202222, 0.0009792967, -0.005712151, 0.005150192, -0.01794303, -0.0048956573, -0.010895399, -0.007345139, -0.005725374, 0.036917422, -0.009447528, 0.042603128, 0.017969476, 0.03094082, -0.0061617186, 0.01459772, 0.0040031336, 0.004340309, 0.01979419, -0.0055799256, 0.020349538, -0.019040504, -0.019648742, 0.019780967, -0.0012842424, 0.03839835, -0.0005590669, -0.023165947, -0.011067293, 0.014015927, 0.012303604, -0.10461699, -0.009315303, 0.00067393796, 0.021195784, -0.017506685, 0.009427694, 0.0045055915, 0.00096194213, 0.015919978, 0.016435657, -0.014095262, 0.0028676454, -0.004730375, -0.0136721395, 0.010306995, -0.0073186937, -0.013401077, -0.0090045715, -0.019344624, 0.009242578, -0.016686887, 0.0007702148, 0.012528387, -0.012025929, -0.022689935, -0.009976431, -0.032236632, 0.02750295, 0.004158499, 0.01855127, 0.002371799, -0.0053320024, 0.007715371, -0.03252753, -0.013500246, 0.011973039, -0.008469057, -0.0022924636, 0.0213809, -0.04842106, 0.018895056, 0.0015858823, 0.007576534, -0.024964217, 0.014994397, 0.0020412346, -0.005249361, 0.0014792753, 0.009348359, -0.03638852, -0.028402084, -0.01084251, -0.019979307, -0.0035304269, 0.0036064566, -0.014994397, 0.017652133, 0.01305729, 0.007907098, 0.006667482, 0.0028676454, -0.020005751, -0.012991177, 0.03001524, -0.00046609566, 0.015615858, -0.02935411, -0.0009925193, 0.033796895, -0.019040504, -0.014901839, 0.009533474, -0.010121879, 0.026458368, -0.038054563, 0.009956597, -0.0030048296, -0.0019519823, 0.016872002, -0.001142926, -0.014941507, -0.02930122, 0.004611372, -0.029512782, 0.030887928, -0.0018015754, 0.010624337, -0.0044791466, -0.007993045, -0.0056790947, 0.0019602464, 0.011173073, 0.0023222142, -0.00022499033, 0.0024511344, 0.015443964, 0.018987615, -0.02349651, -0.008740121, 0.00029730127, -0.004750209, -0.017969476, -0.06442037, 0.006816236, 0.0019833858, 0.0063038613, -0.0054675336, -0.01161603, 0.032818425, -0.030094575, 0.009685534, -0.0012520123, -0.0013090346, 0.0085285595, 0.015959645, -0.0006574098, -0.00688896, -0.019133061, -0.0008057505, 0.009672312, 0.019913195, 0.008145104, -0.012290381, 0.0016139803, 0.026405476, 0.014875393, -0.002168502, 0.012792839, -0.011840814, 0.003464314, 0.0069682957, -0.0073781954, 0.018842166, -0.03165484, -0.017242234, 0.006789791, -0.009130186, -0.012263936, -0.015258849, 0.0036692638, 0.008865735, 0.0272385, -0.004009745, -0.017612467, 0.022584153, -0.023760963, 0.004231223, 0.004287419, -0.020891665, 0.022425482, 0.007986434, -0.0030345803, 0.010459054, 0.013844033, 0.012283769, -0.027899627, -0.006250971, -0.023430398, 0.0122573245, -0.004128748, 0.013830811, -0.016766222, 0.022861827, -0.011192908, 0.03665297, -0.00212057, -0.009031017, -0.024170863, -0.0010230965, -0.0064393925, 0.014015927, -0.005956769, 0.000146378, -0.008436001, 0.010604503, 0.013169682, -0.00516672, 0.0012321784, -0.022332925, -0.0022643656, -0.03993217, 0.02050821, 0.01577453, -0.0043667546, -0.022372592, -0.001152843, 0.010002876, 0.0036262905, -0.017876917, 0.006406336, -0.009401249, 0.019569406, -0.03033258, -0.01269367, 0.0020412346, 0.009989654, -0.0014627471, 0.04101642, 0.0011189602, -0.023046944, 0.0013230836, 0.024250198, 0.01207882, -0.0062377485, -0.010452444, -0.020825552, 0.006693927, -0.005305557, -0.018339708, -0.041307315, -0.012296992, 0.0070542423, 0.0019371068, 0.0117945345, -0.020032197, 0.017797582, -0.015443964, 0.00537167, -0.00015474542, -0.0117747, -0.011140017, 0.017334793, 0.016250541, 0.006019576, 0.017612467, -0.017982699, 0.010366497, 0.0029949127, 0.015086955, -0.000027813887, -0.008660785, -0.008713675, -0.0050873845, -0.0117945345, -0.016118316, -0.0022015583, 0.006518728, -0.0047766543, 0.0055501745, 0.039747052, -0.034061346, 0.049425974, 0.0023883271, -0.0035601775, 0.00863434, -0.003897353, 0.016237319, 0.006436087, -0.00037828952, -0.017797582, -0.019450404, 0.0009809496, 0.0036461244, 0.013176293, 0.0036461244, -0.01094829, -0.018260373, 0.00035246418, 0.012885396, -0.006796402, -0.015972868, 0.027899627, -0.0077021485, 0.027608732, 0.01696456, -0.0014486981, -0.017969476, 0.015642302, -0.00477996, -0.0048890463, -0.020058641, 0.008323609, 0.013017623, -0.01886861, -0.008204606, 0.016303431, -0.010029321, -0.001018138, -0.0332151, 0.010525168, 0.032871313, 0.011549917, 0.010928456, -0.014253933, -0.011384634, 0.00894507, 0.034616694, -0.016872002, -0.010987958, -0.011953205,
	}

	vectorSearchStage := bson.D{
		{"$vectorSearch", bson.D{
			{"index", "vector_index"},
			{"path", "plot_embedding"},
			{"filter", bson.D{{
				"$and", bson.A{
					bson.D{{"year", bson.D{{"$gt", 1955}}}},
					bson.D{{"year", bson.D{{"$lt", 1975}}}},
				},
			}}},
			{"queryVector", queryVector},
			{"numCandidates", 150},
			{"limit", 10},
		}}}

	projectStage := bson.D{
		{"$project", bson.D{
			{"_id", 0},
			{"plot", 1},
			{"title", 1},
			{"year", 1},
			{"score", bson.D{{"$meta", "vectorSearchScore"}}},
		}}}

	scenario := run_queries.AnnFilterScenario{
		Database:          "sample_mflix",
		Collection:        "embedded_movies",
		Embedding:         queryVector,
		VectorSearchStage: vectorSearchStage,
		ProjectStage:      projectStage,
		Expected:          expected,
		Testing:           t,
	}

	if len(scenario.Expected) == 0 {
		fmt.Printf("The scenario has no expected results, so the test will fail. Don't bother to run the test.\n")
		t.FailNow()
	}

	// Test creating the index and performing a query that relies on the index
	manage_indexes.ExampleCreateIndexFilter(t)
	run_queries.ExampleAnnFilterQueryWithScenario(scenario)

	// Drop the index to clear state for future tests
	manage_indexes.ExampleDropIndex()
}
